%\documentclass[onecolumn]{aa} % for a paper on 1 column  
%\documentclass[longauth]{aa} % for the long lists of affiliations
%\documentclass[bibyear]{aa} % if the references are not structured according to the author-year natbib style
\documentclass{aa}  
%\documentclass{memoir}
%\documentclass[oldfontcommands]{memoir}
%\documentclass[twocolumn]{revtex4-2}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{txfonts}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tensor}
\usepackage{derivative}
\usepackage[capitalise]{cleveref}
\usepackage{booktabs}

%\newcommand\TODO[1]{\textcolor{red}{(\textbf{TODO:} #1)}}
\DeclareMathOperator{\asin}{asin}
\DeclareMathOperator{\sinc}{sinc}
\DeclareMathOperator{\diag}{diag}
%\setlength{\mathindent}{20pt}

\begin{document}

\title{AST5220 project report}
%\subtitle{Einstein-Boltzmann solver}
\author{Herman Sletmoen}

%\institute{ITA Oslo}
\date{Spring 2023}

\iffalse
\abstract
% context heading (optional)
{Solve Einstein-Boltzmann equations}
% aims heading (mandatory)
{Solve Einstein-Boltzmann equations}
% methods heading (mandatory)
{Solve Einstein-Boltzmann equations}
% results heading (mandatory)
{Solve Einstein-Boltzmann equations}
% conclusions heading (optional)
{Solve Einstein-Boltzmann equations}
\fi

%\keywords{cosmology -- Einstein-Boltzmann equations}

\maketitle
%
%________________________________________________________________

\section{Introduction}

%\TODO{weave together with the test}

Einstein field equations
\begin{equation}
	G\indices{_\mu_\nu} + \Lambda g\indices{_\mu_\nu} = \frac{8 \pi G}{c^4} T\indices{_\mu_\nu}
\label{eq_einstein}
\end{equation}
energy-momentum tensor
\begin{equation}
	T\indices{^\mu_\nu} = ...
\label{eq_energy_momentum}
\end{equation}

Unless otherwise stated (except with SN?),
Planck (2018?) cosmology
\begin{equation}
\begin{aligned}
h &= 0.67, \\
T_{\rm CMB 0} &= 2.7255\,K, \\
N_{\rm eff} &= 3.046, \\
\Omega_{\rm b 0} &= 0.05, \\
\Omega_{\rm CDM 0} &= 0.267,\\
\Omega_{k 0} &= 0, \\
\Omega_{\nu 0} &= N_{\rm eff}\cdot \frac{7}{8}\left(\frac{4}{11}\right)^{4/3}\Omega_{\gamma 0}, \\
\Omega_{\Lambda 0} &= 1 - (\Omega_{k 0}+\Omega_{b 0}+\Omega_{\rm CDM 0}+\Omega_{\gamma 0}+\Omega_{\nu 0}),\\
n_s &= 0.965, \\
A_s &= 2.1\cdot 10^{-9}, \\
Y_p &= 0.245, \\
z_{\rm reion} &= 8, \\
\Delta z_{\rm reion} &= 0.5, \\
z_{\rm He reion} &= 3.5, \\
\Delta z_{\rm He reion} &= 0.5.
\end{aligned}
\label{eq_planck2018}
\end{equation}


\section{Background cosmology}

TODO: say some introductory stuff

\subsection{Theory}

\subsubsection{Friedmann equation}

The geometry of a spatially homogeneous and isotropic universe, when averaged over large scales,
is described by the \textbf{Friedmann-Lema√Ætre-Robertson-Walker (FLRW) metric}
\begin{equation}
\begin{split}
	ds^2 &= -c^2 dt^2 + a^2(t) \left[\frac{dr^2}{1 - kr^2} + r^2\left(d\theta^2 + \sin^2\theta \, d\phi^2\right) \right] \\
	     &= a^2(t) \left[-c^2 d\eta^2 + \frac{dr^2}{1 - kr^2} + r^2\left(d\theta^2 + \sin^2\theta \, d\phi^2\right) \right].
\end{split}
\label{eq_flrw}
\end{equation}
It is here written in spherical coordinates with curvature $k$, scale factor $a(t)$ and either cosmic time $t$ or conformal time $\eta$,
defined by $d\eta = dt/a$\footnote{I prefer the convention in which conformal time is a time.}, so that it is conformal to the Minkowski metric in the flat case $k=0$.
We model the universe to consist of an ideal fluid with energy density $\rho(t)$, pressure $P(t)$ and thus energy-momentum tensor
\begin{equation}
	T\indices{^\mu_\nu} = \diag\Big[\rho(t),\, -P(t),\, -P(t),\, -P(t)\Big].
\label{eq_energy_momentum_homogeneous}
\end{equation}
The dynamics and evolution of the universe is governed by the Einstein field equations \eqref{eq_einstein}.
In particular, its $(\mu,\nu)=(0,0)$ component gives rise to the Friedmann equation
\begin{equation}
	H(t) = H_0 \sqrt{\Omega_{r0} \, a^{-4} + \Omega_{m0} \, a^{-3} + \Omega_{k0} \, a^{-2} + \Omega_{\Lambda0}}.
\label{eq_friedmann}
\end{equation}
where $F_0 = F(t_0)$ denotes present-day values,
and we define the Hubble parameter $H(t) = \dot{a} / a$
and density parameters
\begin{equation}
	\Omega_s(t) = \frac{\rho_s(t)}{\rho_\text{crit}(t)}
\label{eq_density_parameters}
\end{equation}
for radiation, matter, curvature and the cosmological constant
with (effective) energy densities
\begin{equation}
\begin{aligned}
	\rho_r(t) &= \rho_{r0} a^{-4}, &
	\rho_k(t) &= - 3kc^2 / 8 \pi G a^2 = \rho_{k0} a^{-2}, \\
	\rho_m(t) &= \rho_{m0} a^{-3}, &
	\rho_\Lambda(t) &= \Lambda c^2 / 8 \pi G = \text{constant},
\end{aligned}
\end{equation}
relative to the critical density
$\rho_\text{crit}(t) = 3H^2(t)/8\pi G$.

In addition to the ``cosmic'' Hubble parameter $H = \frac1a \odv{a}{t}$,
we also introduce the \textbf{conformal Hubble parameter}
\begin{equation}
	\mathcal{H} = \frac1a \odv{a}{\eta} = \odv{a}{t} = \dot{a} = a H.
\label{eq_conformal_hubble}
\end{equation}

In particular, in universes dominated by radiation, matter and the cosmological constant,
and denoting $' = \odv{}/{x}$, we have
\begin{equation}
\begin{aligned}
	\mathcal{H} &= H_0 \sqrt{\Omega_{r0}} e^{-x}, &
	\frac{\mathcal{H}'}{\mathcal{H}} &= -1, &
	\frac{\mathcal{H}''}{\mathcal{H}} &= 1 & \Big(\Omega_r \gg \{\Omega_m,\Omega_\Lambda\}\Big) \\
	\mathcal{H} &= H_0 \sqrt{\Omega_{r0}} e^{-\frac12x}, &
	\frac{\mathcal{H}'}{\mathcal{H}} &= -\frac12 &
	\frac{\mathcal{H}''}{\mathcal{H}} &= \frac14 & \Big(\Omega_m \gg \{\Omega_r,\Omega_\Lambda\}\Big) \\
	\mathcal{H} &= H_0 \sqrt{\Omega_{r0}} e^{+x}, &
	\frac{\mathcal{H}'}{\mathcal{H}} &= +1, &
	\frac{\mathcal{H}''}{\mathcal{H}} &= 1 & \Big(\Omega_\Lambda \gg \{\Omega_r,\Omega_m\}\Big).\\
\end{aligned}
\label{eq_conformal_hubble_dominated}
\end{equation}

\subsubsection{Cosmic and conformal time}

The Friedmann equation \eqref{eq_friedmann} is a differential equation for the scale factor $a(t)$.
Instead, we will use its natural logarithm $x = \log a$ to parametrize the evolution of the universe,
and solve $H = \frac1a \odv{a}{t}$ and $d\eta = dt / a$ for the cosmic and conformal times
\begin{equation}
	t = \int_0^a \frac{da}{aH} = \int_0^x \frac{dx}{H}
	\quad \text{and} \quad
	\eta = \int_0^a \frac{da}{a^2 H} = \int_0^x \frac{dx}{aH}.
\label{eq_cosmic_conformal_time}
\end{equation}
In general, these integrals must be computed numerically.
However, in a flat universe with no cosmological constant and radiation-matter equality at $a_\text{eq} = \Omega_{r0}/\Omega_{m0}$,
they can be evaluated analytically to give
\begin{equation}
\begin{aligned}
	t &= \int_0^a \frac{da}{H_0 \sqrt{\Omega_{r0}a^{-2} + \Omega_{m0}a^{-1}}} \\
	  %&= \frac{1}{H_0 \sqrt{\Omega_{m0}}} \int_0^a \frac{da}{\sqrt{a_\text{eq} a^{-2} + a^{-1}}} \qquad \left(a_\text{eq} = \frac{\Omega_{r0}}{\Omega_{m0}}\right)\\
	  &=  \frac{2}{3 H_0 \sqrt{\Omega_{m0}}} \left[\sqrt{a + a_\text{eq}} \big(a - 2 a_\text{eq}\big) + 2 a_\text{eq}^{3/2} \right]
\end{aligned}
\label{eq_cosmic_time_anal}
\end{equation}
and
\begin{equation}
\begin{aligned}
	\eta &= \int_0^a \frac{da}{H_0 \sqrt{\Omega_{r0} + \Omega_{m0} a}} \\
		 %&= \frac{1}{H_0 \sqrt{\Omega_{m0}}} \int_0^a \frac{da}{\sqrt{a_\text{eq} + a}} \qquad \left(a_\text{eq} = \frac{\Omega_{r0}}{\Omega_{m0}}\right) \\
		 &= \frac{2}{H_0 \sqrt{\Omega_{m0}}} \left[ \sqrt{a + a_\text{eq}} - \sqrt{a_\text{eq}}\right].
\end{aligned}
\label{eq_conformal_time_anal}
\end{equation}
In a universe with only radiation, these expressions reduce further to
\begin{equation}
	t = \frac{a^2}{2 H_0 \sqrt{\Omega_{r0}}}
	\quad \text{and} \quad
	\eta = \frac{a}{H_0 \sqrt{\Omega_{r0}}},
\label{eq_cosmic_conformal_time_anal}
\end{equation}
as can also be found by solving the Friedmann equation \eqref{eq_friedmann} with $\Omega_{m} = 0$.

\subsubsection{Distances}

Equipped with conformal time, we can compute distances in the universe.
Consider a photon traveling on a radial path from $(\eta,r)$ directly towards us at $(\eta_0, 0)$ along the null geodesic defined by
\begin{equation*}
	0 = ds^2 = a^2(t) \Big[ -c^2 d\eta^2 + \frac{dr^2}{1-kr^2} \Big].
\end{equation*}
On the comoving grid, it travels the \textbf{comoving distance}
\begin{equation}
	\chi = \int_{\eta}^{\eta_0} c d\eta = c(\eta_0 - \eta) = \int_r^0 \frac{dr}{\sqrt{1-kr^2}} = \frac{\arcsin(\sqrt{k}r)}{\sqrt{k}},
\label{eq_comoving_distance}
\end{equation}
so it came from the radial coordinate
\begin{equation*}
	r = \frac{\sin(\sqrt{k}\chi)}{\sqrt{k}} = \chi \sinc(\sqrt{k}\chi).
\label{eq_radial_coordinate}
\end{equation*}
This equation holds for \emph{all} $k$ with the definition $\sinc(x) = \sin x / x$ with the limit $\sinc(x=0)=1$ and the complex substitution $\sin(ix) = i \sinh x$.
Light with redshift $z$ emitted at the scale factor $a = (1+z)^{-1}$,
define the angular diameter and luminosity distances
\begin{equation}
	d_A = a r
	\quad \text{and} \quad
	d_L = \frac{r}{a} = \frac{d_A}{a^2}.
\label{eq_distances}
\end{equation}



\subsection{Implementation}

\begin{itemize}
	\item Internally, we use $x = \log a$ as a common time input in most functions.
	\item We represent a $\Lambda$CDM cosmology with an object that takes $h$, $\Omega_{b0}$, $\Omega_{c0}$, $\Omega_{k0}$, $T_{\gamma0}$ and $N_\text{eff}$ as free parameters, and then computes the remaining dependent parameters from TODO.
	\item We compute $\mathcal{H}(x)$ and its derivatives $\odv{\mathcal{H}}/{x}$ and $\odv[2]{\mathcal{H}}/{x}$ analytically based on the Friedmann equation \eqref{eq_friedmann} (the derivatives exhibit a nice pattern).
	\item We compute the density parameters \eqref{eq_density_parameters} from today's density parameters using, for example, $\Omega_r = \rho_r / \rho_\text{crit} = (\rho_{r0} a^{-4} / \rho_{\text{crit},0}) (\rho_{\text{crit},0} / \rho_\text{crit}) = \Omega_{r0} a^{-4} (H_0 / H)^2$.
	\item We compute the cosmic time $t(x)$ and conformal time $\eta(x)$ by inserting their derivatives $\odv{t}/{x}$ and $\odv{\eta}/{x}$ into an adaptive 4th(5th)-order adaptive Runge-Kutta integrator.
	      As it is computationally infeasible to start at $x=-\infty$, we pick a small initial value for $x$ and compute its corresponding cosmic time \eqref{eq_cosmic_time_anal} or conformal time \eqref{eq_conformal_time_anal} in a radiation and matter-dominated universe.
	\item If we are in a crazy cosmology in which we can reach $H(x) = 0$ (TODO: elaborate!), we quit the integration early using a callback function.
	\item We spline the integrated $t(x)$ and $\eta(x)$ on a cubic spline, so subsequent computations are both fast and accurate.
	\item We compute the angular diameter and luminosity distance $d_A(z)$ and $d_L(z)$ of light with redshift $z$ emitted at scale factor $a = (1+z)^{-1} = e^x$ by computing the comoving distance \eqref{eq_comoving_distance}, the radial coordinate \eqref{eq_radial_coordinate} and finally one of the distances \eqref{eq_distances}. (TODO: move)
\end{itemize}

\subsection{Results}

We now construct a background cosmology with the Planck 2018 parameters \eqref{eq_planck2018}
and study the evolution of various quantities in this universe as a function of $x = \log a$.

\begin{table*}
\centering
\caption{The time of occurence of four important events in the evolution of a universe with the Planck 2018 cosmology \eqref{eq_planck2018}, expressed in terms of the scale factor $a$, its natural logarithm $x = \log a$, redshift $z = \frac1a - 1$, cosmic time $t$ and conformal time $\eta$.}
\begin{tabular}{l c c c c c}
	\toprule
	Event                                                               & $x$     & $a$       & $z$    & $\eta / \mathrm{Gyr}$    & $t / \mathrm{Gyr}$ \\
	\midrule
	Radiation-matter equality ($\Omega_r = \Omega_m$)                   & $-8.13$ & $0.0003$  & $3400$ & $0.4$ & $0.00005$ \\
	Acceleration onset ($\ddot{a} = 0$)                                 & $-0.49$ & $0.61$    & $0.63$ & $38.5$ & $7.8$   \\
	Matter-cosmological constant equality ($\Omega_m = \Omega_\Lambda$) & $-0.26$ & $0.77$    & $0.29$ & $42.3$ & $10.4$  \\
	Today ($t = t_0$)                                                   & $0$     & $1$       & $0$    & $46.3$ & $13.9$  \\
	\bottomrule
\end{tabular}
\end{table*}

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{../plots/density_parameters.pdf}
\caption{Evolution of the density parameters \eqref{eq_density_parameters} in the Planck 2018 cosmology \eqref{eq_planck2018}.}
\label{fig_density_parameters}
\end{figure}

The evolution of the density parameters in \cref{fig_density_parameters} shows how the universe
\begin{enumerate}
	\item begins in a radiation-dominated epoch with $\Omega_r \gg \{\Omega_m, \Omega_\Lambda\}$,
	\item reaches radiation-matter equality with $\Omega_r = \Omega_m$ at $x = x_{r=m} = -8.13$,
	\item transitions to a matter-dominated epoch with $\Omega_m \gg \{\Omega_r, \Omega_\Lambda\}$,
	\item reaches matter-cosmological constant equality with $\Omega_m = \Omega_\Lambda$ at $x = x_{m=\Lambda} = -0.26$,
	\item transitions to a cosmological constant-dominated epoch with $\Omega_\Lambda \gg \{\Omega_r,\Omega_m\}$.
\end{enumerate}
In this cosmology, there is no curvature $\Omega_{k} = \Omega_{k0} = 0$,
and all density parameters sum to $\Omega_{r} + \Omega_m + \Omega_k + \Omega_\Lambda = 1$ -- as they should, by the Friedmann equation \eqref{eq_friedmann}.

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{../plots/conformal_hubble.pdf}
	\includegraphics[width=\linewidth]{../plots/conformal_hubble_derivative1.pdf}
	\includegraphics[width=\linewidth]{../plots/conformal_hubble_derivative2.pdf}
	\caption{Evolution of the conformal Hubble parameter \eqref{eq_conformal_hubble} and its two derivatives in the Planck 2018 cosmology \eqref{eq_planck2018}, compared to their values \eqref{eq_conformal_hubble_dominated} in universes dominated by radiation, matter and the cosmological constant.}
	\label{fig_conformal_hubble}
\end{figure}

\cref{fig_conformal_hubble} shows the evolution of the conformal Hubble parameter and some of its derivatives,
compared to what they would be in a universe with only radiation, matter or the cosmological constant.
We see that
\begin{itemize}
	\item In the dominated epochs, the evolution closely resembles the dominated ones in \eqref{eq_conformal_hubble_dominated}.
	\item The expansion rate $\dot{a} = \mathcal{H}$ decreases most quickly during radiation domination and slower during matter domination,
	      but begins to \emph{increase} slightly before $\Omega_m = \Omega_\Lambda$.
		  Acceleration begins when $\ddot{a}=0$, or $\odv{\mathcal{H}}/{x} = 0$, that is when $x = x_\text{acc} = -1.0$ (TODO: ?).
\end{itemize}

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{../plots/times.pdf}
	\caption{The cosmic and conformal times \eqref{eq_cosmic_conformal_time} as a function of (natural logarithm of) the scale factor $a$ in the Planck 2018 cosmology \eqref{eq_planck2018}, compared to the analytical expressions \eqref{eq_cosmic_time_anal} in a universe with no cosmological constant.}
	\label{fig_cosmic_conformal_time}
\end{figure}

Next, we study the relation between the scale factor and cosmic and conformal time \eqref{eq_cosmic_conformal_time} in \cref{fig_cosmic_conformal_time}.
\begin{itemize}
	\item The numerically integrated times \eqref{eq_cosmic_conformal_times} matches the analytical times \eqref{eq_cosmic_time_anal} in a universe with no cosmological constant very well until the cosmological constant starts to dominate.
	\item In terms of cosmic time $t$, the universe is $TODO years$ old today.
\end{itemize}

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{../plots/eta_H.pdf}
	\caption{Evolution of the product between the conformal time \eqref{eq_cosmic_conformal_time_anal} and conformal Hubble parameter \eqref{eq_conformal_hubble}, compared to the product between \eqref{eq_conformal_time_anal} and the Hubble parameter \eqref{eq_friedmann} with $\Omega_{k0}=\Omega_{m0}=0$.}
	\label{fig_eta_H}
\end{figure}

As a final test,
instead of testing $\eta$ and $\mathcal{H}$ separately,
we plot the \emph{combination} $\eta \mathcal{H}$ in \cref{eq_eta_H}.
Its value in a universe with no cosmological constant is known exactly from the conformal time \eqref{eq_conformal_time_anal} and Hubble parameter \eqref{eq_friedmann} with $\Omega_{k0}=\Omega_{\Lambda0}=0$.
In particular, back in time in the radiation-dominated era, the product between \eqref{eq_cosmic_conformal_time_anal} and \eqref{eq_conformal_hubble_dominated} should converge towards $1$.


\section{Supernova data}

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{../plots/supernova_distance.pdf}
	\includegraphics[width=\linewidth]{../plots/supernova_hubble.pdf}
	\includegraphics[width=\linewidth]{../plots/supernova_omegas.pdf}
\end{figure}

%
%______________________________________________________________

\section{Conclusions}


% WARNING
%-------------------------------------------------------------------
% Please note that we have included the references to the file aa.dem in
% order to compile it, but we ask you to:
%
% - use BibTeX with the regular commands:
%   \bibliographystyle{aa} % style aa.bst
%   \bibliography{Yourfile} % your references Yourfile.bib
%
% - join the .bib files when you upload your source files
%-------------------------------------------------------------------

\end{document}
